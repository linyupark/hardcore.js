riot.tag2("agreement-form",'<section><h2> 管理后台 &gt; {app.lang.admin.agreement.title} &gt; {app.lang.admin.agreement[app.route.params[1]]} </h2><form class="agreement"><span if="{form.update_at}" class="header-mark"> 最后更新: {form.update_at?app.utils.time2str(form.update_at):\'-\'} 操作人: {form.operator_user_name||\'-\'} </span><h4>帐号信息</h4><div class="c2"><div class="row"><p><label>{app.lang.admin.agreement.number}</label><input type="text" ref="agreement_number" riot-value="{form.agreement_number}" placeholder="{app.lang.admin.form.req}"><input-valid ref="validOnSave" for="agreement_number" rule="required" msg="{app.lang.admin.agreement.number}{app.lang.admin.form.req}"></input-valid></p><p><label>{app.lang.admin.agreement.name}</label><input type="text" ref="agreement_name" riot-value="{form.agreement_name}" placeholder="{app.lang.admin.form.req}"><input-valid ref="validOnSave" for="agreement_name" rule="required" msg="{app.lang.admin.agreement.name}{app.lang.admin.form.req}"></input-valid></p></div><div class="row"><p><label>{app.lang.admin.agreement.donor}</label><donor-select ref="donor"></donor-select></p><p><label>{app.lang.admin.agreement[\'donor:nature\']}</label><select ref="donor_nature"><option each="{donorNature}" riot-value="{key}" selected="{form.donor_nature==key}">{name}</option></select></p></div><div class="row"><p><label>{app.lang.admin.agreement.donations}</label><label class="radio"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" name="alumni_donations" ref="alumni_donations" checked="{form.alumni_donations==1}"> {app.lang.yes} </label><label class="radio"><input type="radio" name="alumni_donations" ref="alumni_donations" checked="{form.alumni_donations==0}"> {app.lang.no} <label></p><p><label>{app.lang.admin.agreement[\'sources:funding\']}</label><select ref="sources_funding"><option each="{sourcesFunding}" riot-value="{key}" selected="{form.sources_funding==key}">{name}</option></select></p></div><div class="row"><p><label>{app.lang.admin.agreement.contract}</label><input ref="contract_date" class="date" type="text" onclick="WdatePicker()" placeholder="{app.lang.admin.form.req}" riot-value="{form.contract_date && app.utils.time2str(form.contract_date, {sp:\'-\'})}"><i class="icon-calendar"></i><input-valid ref="validOnSave" for="contract_date" rule="required" msg="请选择日期"></input-valid></p><p><label>{app.lang.admin.agreement.deadline}</label><input ref="deadline" type="text" riot-value="{form.deadline}" placeholder="{app.lang[\'year:number\']}"><input-valid ref="validOnSave" for="deadline" rule="+int" msg="格式错误"></input-valid></p></div><div class="row"><p><label>{app.lang.admin.agreement.due}</label><input ref="due_date" class="date" type="text" onclick="WdatePicker()" placeholder="{app.lang.admin.form.req}" riot-value="{form.due_date && app.utils.time2str(form.due_date, {sp:\'-\'})}"><i class="icon-calendar"></i><input-valid ref="validOnSave" for="due_date" rule="required" msg="请选择日期"></input-valid></p><p></p></div></div><hr><br><h4>捐赠信息</h4><br><div class="c1"><label class="top" style="padding-top: 10px">{app.lang.admin.agreement[\'project:type\']}</label><div class="line"><label style="width: 120px" each="{projectType}" class="checkbox"><input type="checkbox" riot-value="{id}" ref="projectType" checked="{fn.checkProjectType(id)}"> {name} </label></div></div><div class="c1"><label class="top">货币捐赠</label><div class="line"><p each="{p in form.price}" class="price-group"><select placehoder="货币种类" disabled><option each="{c in currencyList}" riot-value="{c[0]}" selected="{c[0]==p.currency_sign}">{c[1]}</option></select><input type="text" placeholder="金额" riot-value="{p.amount}" disabled><a href="javascript:;" onclick="{fn.removePrice}"><i class="icon-cancel"></i></a></p><p class="price-group"><select ref="addPriceType" placehoder="货币种类"><option each="{c in currencyList}" riot-value="{c[0]}">{c[1]}</option></select><input type="text" ref="addPriceNumber" placeholder="金额"><a href="javascript:;" onclick="{fn.addPrice}"><i class="icon-plus"></i></a><input-valid ref="validPrice" for="addPriceNumber" rule="required,number" msg="金额必须为数字"></input-valid></p></div></div><div class="c1"><label class="top">获奖条件说明</label><p><textarea ref="award_condition">{form.award_condition}</textarea></p></div><hr><br><h4>附属信息</h4><br><div class="c2"><div class="row"><label class="top">附件上传</label><p><upload-formdata name="file[]"></upload-formdata> &nbsp;&nbsp;<span style="font-size: 12px; color: #ccc">{fileUploadPercent}</span></p><p><span class="files" each="{form.file}"><a href="javascript:;" onclick="{fn.removeFile}"><i style="margin-left: 0" class="icon-cancel"></i></a> {file_name} </span></p></div></div><div class="c1"><label class="top">协议录入人</label><p><input type="text" ref="user_name" riot-value="{form.user_name||app.data.user_name}"></p></div><div class="c1"><label class="top">协议备注</label><p><textarea ref="remark">{form.remark}</textarea></p></div><hr><div class="c1 btn-line"><button type="button" onclick="{fn.save}" class="btn-yellow">{app.lang.admin.btn.save}</button><button type="button" onclick="{fn.cancel}" class="btn-gray">{app.lang.admin.btn.back}</button></div></form></section>',"","",function(e){var t=this;t.form={price:[],file:[],donor:{}},t.cache={},t.donorNature=t.app.lang.admin.agreement["donor:nature:list"],t.sourcesFunding=t.app.lang.admin.agreement["sources:funding:list"],t.projectType=[],t.fn={save:function(e){t.app.validAll(t.refs.validOnSave.concat(t.refs.donor)).then(function(){var n,r,i=[],a=t.app.Promise.resolve(!0);t.refs.alumni_donations[0].checked&&(r=1),t.refs.alumni_donations[1].checked&&(r=0),t.refs.projectType.forEach(function(e){e.checked&&i.push({project_types_id:e.value})}),n=t.form.id?"agreement/default/update?id="+t.form.id:"agreement/default/create",t.refs.addPriceNumber.value&&(a=t.fn.addPrice()),a.then(function(){t.app.api("POST",n,{trigger:e.target,data:{data:JSON.stringify({agreement_number:t.refs.agreement_number.value,agreement_name:t.refs.agreement_name.value,donor_id:t.refs.donor.getId(),deadline:parseInt(t.refs.deadline.value,10),contract_date:t.app.utils.str2time(t.refs.contract_date.value),due_date:t.app.utils.str2time(t.refs.due_date.value),award_condition:t.refs.award_condition.value,donor_nature:t.refs.donor_nature.value,alumni_donations:r,sources_funding:t.refs.sources_funding.value,remark:t.refs.remark.value,file:t.form.file||[],price:t.form.price||[],project_type:i})}}).on("done",function(){t.app.alert("协议保存成功","success"),!t.form.id&&t.app.route("admin-agreement")})})}).catch(function(){t.app.alert("保存前请检查您的表单数据","warning")})},removeFile:function(e){t.form.file.splice(t.form.file.indexOf(e.item),1)},cancel:function(){history.back()},checkProjectType:function(e){var n=!1;if(t.form.project_type)return t.form.project_type.forEach(function(t){t.project_types_id==e&&(n=!0)}),n},removePrice:function(e){t.form.price.splice(t.form.price.indexOf(e.item.p),1)},addPrice:function(e){return new t.app.Promise(function(e){t.refs.validPrice.once("valid",function(){t.form.price.push({currency_sign:t.refs.addPriceType.value,amount:Number(t.refs.addPriceNumber.value)}),t.refs.addPriceNumber.value="",t.refs.addPriceType.value="CNY",t.update(),e()}).emit("check")})},currencyCode:function(){t.app.api("GET","agreement/default/currency-code").on("done",function(e){t.update({currencyList:e.items})})}},t.on("mount",function(){if("edit"==t.app.route.params[1]){if(t.agreement_id=t.app.route.params[2],!t.agreement_id)return t.app.alert("协议id错误","error"),history.back();t.app.api("GET","agreement/default/update",{data:{id:t.agreement_id}}).on("done",function(e){t.form=e,t.form.donor=e.donor||{},t.form.file=e.file||[],t.form.price=e.price||[],t.form.project_type=e.project_type||[],t.refs.donor.emit("set",{id:t.form.donor.id,name:t.form.donor.donor_name}),t.update()})}t.app.addResource("my97"),t.fn.currencyCode(),t.app.getProjectTypeList(function(e){t.update({projectType:e})}),t.tags["upload-formdata"].on("post",function(e){t.app.api("POST","agreement/default/upload-file",{payload:!0,showProgress:!0,formdata:!0,data:e}).on("done",function(e){t.form.file=t.form.file.concat(e.items),t.update()}).on("progress",function(e){t.update({fileUploadPercent:100==e?"上传完毕":e+"%"})})})})}),riot.tag2("fp-admin-agreement",'<header for="admin"></header><main class="admin"><div class="container"><admin-sidenav></admin-sidenav><agreement-form if="{section==\'add\'}"></agreement-form><agreement-form if="{section==\'edit\'}"></agreement-form><section if="{section==\'index\'}"><h2>管理后台 &gt; {app.lang.admin.agreement.title}</h2><table-filter for="agreement"><yield to="addon"><button class="main" onclick="{parent.fn.add}"><i class="icon-plus"></i> {app.lang.admin.agreement.add} </button></yield></table-filter><table class="base"><thead><tr><th width="10%">{app.lang.admin.agreement.id}</th><th width="10%">{app.lang.admin.agreement.number}</th><th width="50%">{app.lang.admin.agreement.name}</th><th width="10%">{app.lang.admin.agreement.contract}</th><th width="10%">{app.lang.admin.agreement.due}</th><th width="10%">{app.lang.admin.handle}</th></tr></thead><tbody><tr each="{tableList}"><td>{id}</td><td>{agreement_number}</td><td class="left">{agreement_name}</td><td>{app.utils.time2str(contract_date)}</td><td>{app.utils.time2str(due_date)}</td><td><a href="javascript:;" aria-label="{app.lang.admin.handles.edit}" class="c-tooltip--top"><i onclick="{fn.edit}" class="btn-icon icon-pencil"></i></a><a href="javascript:;" aria-label="{app.lang.admin.handles.remove}" class="c-tooltip--top"><i onclick="{fn.remove}" class="btn-icon icon-trash"></i></a></td></tr><tr if="{!tableList}"><td colspan="6"><spinner-dot></spinner-dot></td></tr></tbody><tfoot if="{tableList}"><tr><td class="left" colspan="6"> {app.lang.admin.counts.items} <b>{items}</b> {app.lang.admin.counts.unit} </td></tr></tfoot></table><pagination-number page="{page}" pages="{pages}" select="y"></pagination-number></section><footer class="admin"></footer></div></main><modal-remove></modal-remove>',"","",function(e){var t=this;t.q=t.app.route.query,t.section=t.app.route.params[1]||"index",t.fn={add:function(){t.app.route(t.app.route.path+"/add")},edit:function(e){t.app.route(t.app.route.path+"/edit/"+e.item.id)},remove:function(e){t.tags["modal-remove"].emit("open").once("ok",function(){t.app.api("GET","agreement/default/delete",{data:{id:e.item.id}}).on("done",function(){t.app.alert("协议删除成功","success"),t.fn.getList()})})},getList:function(){t.app.api("GET","agreement/default/index",{data:{page:t.q.page||1,search_type:t.q.type||"",search_keyword:t.q.keyword||""}}).on("done",function(e){t.update({tableList:e.items,page:e.counts.page,pages:e.counts.total_page,items:e.counts.total_items}),t.tags["pagination-number"].emit("render")})}},t.on("mount",function(){"index"===t.section&&(t.fn.getList(),t.tags["pagination-number"].on("change",function(e){t.q.page=e,t.app.query()}))})});