riot.tag2("daily-form",'<section><h2>管理后台 &gt; 工作日志 &gt; {did?\'修改\':\'新增\'}日志</h2><form class="user-daily" onsubmit="return false"><h4>{did?\'修改\':\'新增\'}日志</h4><div class="row c4"><p><label class="top">关联对象</label><span class="relList" each="{rels}"><a href="javascript:;" onclick="{fn.rmRel}"><i class="icon-cancel"></i></a> &nbsp; <select onchange="{fn.changeRelType}"><option each="{parent.relTypeList}" riot-value="{k}" selected="{k==type_id}">{name}</option></select> &nbsp; <donor-select ref="relValue" if="{type_id==1}"></donor-select><org-select ref="relValue" if="{type_id==2}"></org-select><agreement-select ref="relValue" if="{type_id==3}"></agreement-select><project-select ref="relValue" if="{type_id==4}"></project-select></span><span class="relList" style="padding-top:20px"><a href="javascript:;" onclick="{fn.addRel}"><i class="icon-plus"></i> &nbsp;&nbsp;&nbsp;添加 </a></span></p></div><div class="row" style="position: relative"><p><label class="top">详细内容</label><tinymce-editor if="{editInited}" ref="edit" style="float: left" w="700px" h="300px"></tinymce-editor></p><user-select if="{pos.x}" for="admin" riot-style="position: absolute; left: {pos.x+70||0}px; top: {pos.y+43||0}px;" ref="user"></user-select></div><br><br><div class="c1 btn-line"><button type="button" onclick="{fn.save}" class="btn-yellow">{app.lang.admin.btn.save}</button><button type="button" onclick="{fn.cancel}" class="btn-gray">{app.lang.admin.btn.back}</button></div><br><br><br></form></section>','daily-form .relList,[data-is="daily-form"] .relList{width: 92%; float: right; margin-bottom: 25px; position: relative;}',"",function(e){var t=this;t.did=t.app.route.params[2],t.daily={},t.pos={},t.rels=[],t.relTypeList=[{k:1,name:"捐赠方"},{k:2,name:"机构"},{k:3,name:"协议"},{k:4,name:"项目"}],t.fn={cancel:function(e){history.back()},save:function(e){var n="daily-manager/default/create",a=[],i=function(){return t.refs.edit.getContent()?void t.app.api("POST",n,{trigger:e.target,data:{data:JSON.stringify({relation:a,content:t.refs.edit.getContent()})}}).on("done",function(){t.app.alert("日志保存成功","success"),!t.did&&t.app.route("admin-daily")}):t.app.alert("请填写内容","warning")};return t.did&&(n="daily-manager/default/update?id="+t.did),t.refs.relValue?void t.app.validAll([].concat(t.refs.relValue)).then(function(){t.rels.forEach(function(e,n){var i=t.refs.relValue[n]||t.refs.relValue;t.rels[n].value_id=i.getId(),a.push(t.rels[n])}),i()}).catch(function(){t.app.alert("请检查表单数据","warning")}):i()},changeRelType:function(e){e.item.type_id=e.target.value},rmRel:function(e){t.rels.splice(t.rels.indexOf(e.item),1)},addRel:function(e){t.rels.push({type_id:1,value_id:0,value_name:""})},getDaily:function(){t.app.api("GET","daily-manager/default/update",{data:{id:t.did}}).on("done",function(e){t.update({daily:e,rels:e.relation}),t.refs.edit.once("inited",function(){this.emit("setContent",e.content)}),e.relation&&e.relation.forEach(function(e,n){var a=t.refs.relValue[n]||t.refs.relValue;2==e.type_id?a.emit("set",e.value_id):a.emit("set",{name:e.value_name,id:e.value_id})})})}},t.on("mount",function(){t.app.addResource("tinymce").then(function(){t.editInited=!0,t.update(),t.did&&t.fn.getDaily(),t.refs.edit.on("keyup",function(e,n){if(8==e.keyCode&&"atuser"===n.edit.selection.getNode().getAttribute("class")&&n.edit.selection.select(n.edit.selection.getNode()),e.shiftKey&&50==e.keyCode){var a=t.refs.edit.getContent().slice(0,-1);t.update({pos:n.pos}),t.refs.user.emit("focus").once("select",function(e){t.refs.edit.emit("setContent",a),e.real_name&&t.refs.edit.emit("insertContent",'<span class="atuser">@'+e.real_name+"</span>，"),setTimeout(function(){t.update({pos:{}})},101)})}})})})}),riot.tag2("fp-admin-daily",'<header for="admin"></header><main class="admin"><div class="container"><admin-sidenav></admin-sidenav><daily-form if="{section==\'add\'}"></daily-form><daily-form if="{section==\'edit\'}"></daily-form><section if="{section==\'index\'}"><h2>管理后台 &gt; 工作日志</h2><form class="user-daily" onsubmit="return false"><div class="top-tab-line"><a href="javascript:;" onclick="{fn.rangeChange}" class="c4 {active: k==parent.q.range}" each="{rangeList}">{name}<i if="{k==\'information\'&&app.data.unread>0}">{app.data.unread}</i></a></div><table-filter for="daily"><yield to="addon"><button type="button" class="main" onclick="{parent.fn.add}"><i class="icon-plus"></i> 添加新日志 </button></yield></table-filter><div if="{!dailyList}" class="daily-box"><br><br><spinner-dot></spinner-dot></div><div if="{dailyList&&dailyList.length==0}" class="daily-box"><br><br><p style="text-align: center">没有相关日志</p></div><div each="{dailyList}" class="daily-box"><p class="user-date"><strong>{user_name}</strong><span> {app.utils.time2str(created_at, {showtime: 1})} </span></p><p class="rel" if="{relation.length}"> 关联对象: <span each="{relation}">{value_name}; </span></p><div class="content" if="{app.utils.pureText(content).length<200}"><raw content="{content}"></raw></div><div if="{app.utils.pureText(content).length>=200}" class="content {fadein: unfold}"><raw if="{unfold}" content="{content}"></raw> {!unfold ? app.subText(app.utils.pureText(content), 200) : \'\'} <a class="under-line" onclick="{fn.unfold}" href="javascript:;">{unfold?\'收起\':\'展开\'}</a></div><div class="handle-line"><a href="javascript:;" onclick="{fn.read}" if="{q.range==\'information\'}" if="{myself}">标为已读</a><a href="javascript:;" onclick="{fn.checkMsg}">评论({msgList[id].length})</a><a href="javascript:;" onclick="{fn.edit}" if="{myself}">修改</a><a href="javascript:;" onclick="{fn.remove}" if="{myself}">删除</a></div><div class="{fadein: checkMsgId==id}" if="{checkMsgId==id}"><div class="comment"><input ref="comment" type="text" placeholder="评论 {msg.user_name}: {msg.content}" onkeyup="{fn.cmtKeyup}" maxlength="100"><user-select if="{parent.atX}" for="admin" riot-style="position: absolute; left: {parent.atX}px; top: 20px" ref="atuser"></user-select><span class="count-px" ref="cloneTxt">{parent.cloneTxt}</span><input-valid ref="validComment" for="comment" rule="required" msg=""></input-valid><button type="button" onclick="{fn.send}">发送</button></div><ul class="comment-list"><li each="{msgList[id]}"><p><span class="blank" riot-style="width: {Number(lv)*10}px"></span><span class="c-name"><a href="javascript:;" onclick="{fn.reply}" class="under-line">{data.user_name}</a></span><span if="{lv>0}" class="c-reply"> 回复 </span><span class="c-name">{pname}:</span><span class="c-content">{data.content}</span><span class="c-time">{app.utils.time2str(data.created_at, {showtime:1})}</span><a href="javascript:;" class="c-rm" if="{myself&&data.is_deleted==0}" onclick="{fn.rmCmt}"><i class="icon-cancel"></i></a></p></li></ul></div></div></form><pagination-number page="{page}" pages="{pages}" select="y"></pagination-number></section></div></main><footer class="admin"></footer><modal-remove></modal-remove>','fp-admin-daily .fadein,[data-is="fp-admin-daily"] .fadein{ animation: fadeIn .5s; } fp-admin-daily .top-tab-line i,[data-is="fp-admin-daily"] .top-tab-line i{ font-size: 12px; display: inline-block; height: 18px; width: 18px; border-radius: 18px; background: #E01B46; line-height: 18px; color: #fff; vertical-align: text-bottom; font-style: normal; text-align: center; margin-left: 6px; }',"",function(e){var t=this;t.q=t.app.route.query,t.q.range=t.q.range||"my",t.section=this.app.route.params[1]||"index",t.checkMsgId=0,t.msg={},t.msgList={},t.rangeList=[{k:"my",name:"与我相关"},{k:"information",name:"新消息"},{k:"all",name:"所有"},{k:"department",name:"本部门"}],t.fn={remove:function(e,n){t.tags["modal-remove"].emit("open").once("ok",function(){t.app.api("GET","daily-manager/default/delete",{data:{id:e.item.id||e.item.data.id}}).on("done",function(){t.app.alert((n||"日志")+"删除成功","success"),t.fn.getDailyList()})})},rmCmt:function(e){t.fn.remove(e,"评论")},cmtKeyup:function(e){t.cloneTxt=e.target.value.slice(0,e.target.selectionEnd),e.shiftKey&&50==e.keyCode&&(t.atX=t.refs.cloneTxt.clientWidth>=t.refs.comment.clientWidth?t.refs.comment.clientWidth:t.refs.cloneTxt.clientWidth+23,t.update(),t.refs.atuser.emit("focus").once("select",function(n){n.real_name?t.refs.comment.value=t.refs.comment.value.replace(t.cloneTxt,t.cloneTxt+n.real_name+"，"):t.refs.comment.value=e.target.value.slice(0,-1),t.cloneTxt=e.target.value.slice(0,e.target.selectionEnd),t.refs.comment.focus(),setTimeout(function(){t.update({atX:0})},101)}))},read:function(e){t.app.api("GET","daily-manager/default/information",{trigger:e.target,data:{read:e.item.id}}).on("done",function(){t.dailyList.splice(t.dailyList.indexOf(e.item),1),t.app.data.unread-=1,t.update()})},unfold:function(e){e.item.unfold=!e.item.unfold},edit:function(e){t.app.route(t.app.route.path+"/edit/"+e.item.id)},add:function(e){t.app.route(t.app.route.path+"/add")},send:function(e){t.refs.validComment.once("invalid",function(){t.app.alert("请填写回复内容","warning")}).once("valid",function(){t.app.api("POST","daily-manager/default/create",{trigger:e.target,data:{data:JSON.stringify({reply_id:t.msg.id,sign:t.msg.sign,content:t.refs.comment.value})}}).on("done",function(){t.app.alert("回复成功","success"),t.fn.getDailyList()})}).emit("check")},reply:function(e){t.msg=e.item.user_name?e.item:e.item.data},checkMsg:function(e){t.checkMsgId=t.checkMsgId==e.item.id?0:e.item.id,t.msg={id:e.item.id,sign:e.item.sign,content:t.app.subText(t.app.utils.pureText(e.item.content),20)}},scanMessage:function(e,n,a,i){t.msgList[e]=t.msgList[e]||[],n.forEach(function(n){t.msgList[e].push({lv:a,data:n,pname:i||""}),n.child.length>0&&t.fn.scanMessage(e,n.child,a+1,n.user_name)})},rangeChange:function(e){t.q.range=e.item.k,t.app.query()},getUnread:function(){t.app.api("GET","backend/default/remind").on("done",function(e){t.app.data.unread=e.new_daily_message_num,t.update()})},getDailyList:function(e){var n="daily-manager/default/"+t.q.range;t.app.api("GET",n,{data:{page:t.q.page||1}}).on("done",function(e){t.dailyList=e.items,t.page=e.counts.page,t.pages=e.counts.total_page,t.items=e.counts.total_items,t.msgList={},e.items.forEach(function(e){t.fn.scanMessage(e.id,e.message,0)}),t.update(),t.tags["pagination-number"].emit("render"),t.msg.content=""}),t.fn.getUnread()}},this.on("mount",function(){"index"===t.section&&(t.tags["pagination-number"].on("change",function(e){t.q.page=e,t.app.query()}),t.fn.getDailyList())})});